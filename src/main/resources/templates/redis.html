<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>REDIS KEY 管理</title>
    <script src="assets/common/base.css"></script>
    <link href="assets/bootstrap3/css/bootstrap.min.css" rel="stylesheet">
    <link href="assets/bootstrap3/css/bootstrap-select.css" rel="stylesheet">

    <link type="text/css" rel="stylesheet" href="http://cdn.bootcss.com/font-awesome/4.6.3/css/font-awesome.min.css">

    <!--<link href="/assets/common/pagination/common.css" rel="stylesheet">-->
    <!--<link href="/assets/common/pagination/reset.css" rel="stylesheet">-->
    <!--<link href="/assets/common/pagination/highlight.min.css" rel="stylesheet">-->
    <link href="assets/common/pagination/pagination.css" rel="stylesheet">
    <link href="assets/css/toastr.min.css" rel="stylesheet">
    <script src="assets/common/base.js"></script>
    <script src="assets/jquery/jquery-1.12.4.min.js"></script>
    <script src="assets/bootstrap3/js/bootstrap.min.js"></script>
    <!--<script src="/assets/common/pagination/jquery.min.js"></script>-->
    <!--导致模态框的modal方法无效 所以注释 具体原因可能是跟上面的冲突 -->
    <script src="assets/common/pagination/highlight.min.js"></script>
    <script src="assets/common/pagination/jquery.pagination.js"></script>
    <script src="assets/bootstrap3/js/bootstrap-select.js"></script>
    <script src="assets/js/i18n/defaults-zh_CN.js"></script>
    <script src="assets/js/toastr.min.js"></script>
</head>
<body style="padding: 70px 20px;">

<!--loading遮罩-->
<div class="J_myModal modal-backdrop fade in"
     style="display: none;opacity: 0.7;">
    <img style="left: 50%;margin-left: -80px;margin-top: -90px;position: relative;top: 50%;"
         src="assets/image/loading.gif">
</div>


<!--添加key弹出框-->

<div class="modal fade" id="addKeyModal" data-backdrop="static" tabindex="-1" role="dialog"
     aria-labelledby="exampleModalLabel">
    <div class="modal-dialog modal-md" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span
                        aria-hidden="true">×</span></button>
                <h4 class="modal-title">redis key 添加</h4>
            </div>
            <!-- /.box-header -->
            <!-- form start -->
            <div class="modal-body">

                <form class="form-horizontal">


                    <div class="form-group" style="padding-top: 3%">
                        <label for="add-redis-key-name" class="col-sm-2 control-label">名称:</label>
                        <div class="col-sm-4">
                            <input type="text" class="form-control " placeholder="输入key名称(不可为空)"
                                   id="add-redis-key-name">
                        </div>
                    </div>


                    <div class="form-group">
                        <label for="add-redis-key" class="col-sm-2 control-label">key:</label>
                        <div class="col-sm-6">
                            <input type="text" class="form-control " placeholder="输入key(不可为空)"
                                   id="add-redis-key">
                        </div>
                    </div>
                    <!--key类型-->
                    <div class="form-group">
                        <label for="add-redis-key-type" class="col-sm-2 control-label">类型:</label>
                        <div class="col-sm-6">
                            <select class="selectpicker" data-style="btn-info" title="key类型" id="add-redis-key-type">
                                <option data-content="<span class='label label-success'>string</span>">string
                                </option>
                                <option data-content="<span class='label label-info'>hash</span>">hash</option>
                                <option data-content="<span class='label label-warning'>list</span>">list
                                </option>
                                <option data-content="<span class='label label-danger'>set</span>">set</option>
                                <option data-content="<span class='label label-danger'>zset</span>">zset
                                </option>
                            </select>
                        </div>
                    </div>

                    <div class="form-group">
                        <label for="add-redis-key-bizType" class="col-sm-2 control-label">业务类型:</label>
                        <div class="col-sm-4">
                            <select class="selectpicker" data-style="btn-info" title="key业务类型"
                                    id="add-redis-key-bizType">
                                <option value="others" data-content="<span class='label label-success'>其他</span>">string
                                </option>
                            </select>
                        </div>
                    </div>

                    <div class="form-group">
                        <label for="add-redis-parent-key" class="col-sm-2 control-label"> 父级key:</label>
                        <div class="col-sm-6">
                            <input type="text" class="form-control " placeholder="输入父级key(可为空)"
                                   id="add-redis-parent-key">
                        </div>
                    </div>
                    <div class="form-group" style="padding-top: 3%">
                        <label for="add-key-description" class="col-sm-2 control-label">描述:</label>
                        <div class="col-sm-8">
                                <textarea class="form-control" rows="4"
                                          id="add-key-description"></textarea>
                        </div>
                    </div>

                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-default" data-dismiss="modal">取消</button>
                <button type="button" class="add_redis_button btn btn-danger">确定</button>
            </div>
        </div>
    </div>
</div>


<!--key详情展示 -->
<div class="modal fade" id="showKeyDetail" tabindex="-1" role="dialog" aria-labelledby="exampleModalLabel">
    <div class="modal-dialog modal-lg" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span
                        aria-hidden="true">×</span></button>
                <h4 class="modal-title" id="keyDetailTitle">redis key 信息</h4>
            </div>
            <div class="modal-body">
                <form class="form-horizontal">

                    <div class="form-group" style="padding-top: 3%">
                        <label for="detail-redis-key-name" class="col-sm-2 control-label">名称:</label>
                        <div class="col-sm-4">
                            <input type="text" class="form-control " placeholder="输入key名称(不可为空)"
                                   id="detail-redis-key-name">
                        </div>
                    </div>


                    <div class="form-group">
                        <label for="detail-redis-key" class="col-sm-2 control-label">key:</label>
                        <div class="col-sm-4">
                            <input type="text" class="form-control " placeholder="输入key(不可为空)"
                                   id="detail-redis-key">
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="detail-redis-key-type" class="col-sm-2 control-label">类型:</label>
                        <div class="col-sm-6">
                            <select class="selectpicker" data-style="btn-info" title="key类型" id="detail-redis-key-type">
                                <option data-content="<span class='label label-success'>string</span>">string
                                </option>
                                <option data-content="<span class='label label-info'>hash</span>">hash</option>
                                <option data-content="<span class='label label-warning'>list</span>">list
                                </option>
                                <option data-content="<span class='label label-danger'>set</span>">set</option>
                                <option data-content="<span class='label label-danger'>zset</span>">zset
                                </option>
                            </select>
                        </div>
                    </div>

                    <div class="form-group">
                        <label for="detail-redis-key-bizType" class="col-sm-2 control-label">业务类型:</label>
                        <div class="col-sm-4">
                            <select class="selectpicker" data-style="btn-info" title="key业务类型"
                                    id="detail-redis-key-bizType">
                                <option value="others" data-content="<span class='label label-success'>其他</span>">string
                                </option>
                            </select>
                        </div>
                    </div>

                    <div class="form-group">
                        <!--for="detail-redis-parent-key"-->
                        <label  class="col-sm-2 control-label"> 父级key:</label>
                        <div class="col-sm-6">
                            <input type="text" class="form-control detail-redis-parent-key" placeholder="输入父级key(可为空)"
                                   <!--id="detail-redis-parent-key"-->>
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="detail-key-description" class="col-sm-2 control-label">描述:</label>
                        <div class="col-sm-8">
                                <textarea class="form-control" rows="4"
                                          id="detail-key-description"></textarea>
                        </div>
                    </div>


                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
                <button type="button" class="add_redis_button btn btn-danger">确定
                </button>
            </div>
        </div>
    </div>
</div>

<!--搜索栏-->

<div class="box box-danger">
    <div class="box-header with-border">
        <h3 class="box-title">Search Form</h3>
    </div>
    <div class="box-body col-sm-12">
        <div class="form-group col-xs-10">

            <div class="form-group col-xs-3">
                <input type="text" class="form-control" id="search-redis-key-name" placeholder="请输入要查询的key名称">
            </div>
            <div class="form-group col-xs-3">
                <input type="text" class="form-control" id="search-redis-key" placeholder="请输入要查询的key">
            </div>
            <div class="form-group col-xs-4">
                <input type="text" class="form-control" id="search-redis-parent-key" placeholder="请输入要查询的父级key">
            </div>
            <div class="box-body col-xs-2">
                <button type="button" class="btn btn-block btn-success" style="width: 60%" data-toggle="modal"
                        data-target="#addKeyModal">
                    <span><i class="fa fa-fw fa-plus-square"></i></span>
                    添加
                </button>
            </div>
        </div>

        <div class="form-group col-xs-8">

            <div class="col-xs-2">
                <select class="selectpicker" data-style="btn-info" title="类型"
                        id="search-redis-key-type">
                    <option value="" data-content="<span class='label label-success'>全部</span>">全部
                    </option>
                    <option data-content="<span class='label label-success'>string</span>">string
                    </option>
                    <option data-content="<span class='label label-info'>hash</span>">hash</option>
                    <option data-content="<span class='label label-warning'>list</span>">list
                    </option>
                    <option data-content="<span class='label label-danger'>set</span>">set</option>
                    <option data-content="<span class='label label-danger'>zset</span>">zset
                    </option>
                </select>

            </div>
            <div class="col-xs-2" style="margin-left: 10%">
                <select class="selectpicker" data-style="btn-info" title="key业务类型"
                        id="search-redis-key-bizType">
                    <option value="" data-content="<span class='label label-success'>全部</span>">全部
                    </option>
                    <option value="others" data-content="<span class='label label-success'>其他</span>">string
                    </option>
                </select>
            </div>
            <div class="box-body col-xs-2" style="margin-left: 10%">
                <button id="search-redis-list" class="btn btn-info ">Search</button>
            </div>
        </div>


    </div>


</div>
<!-- redis key列表-->
<table class="table table-striped">
    <thead>
    <tr>
        <th>key名称</th>
        <!--style="width:18%;"-->
        <th>key值</th>
        <th>类型</th>
        <th>父级key</th>
        <th>描述</th>
        <th>创建时间</th>
        <th>最近修改时间</th>
        <th>操作</th>
    </tr>
    </thead>
    <tbody class="redisList_table">
    </tbody>
</table>
<div class="eg">
    <div class="m-style M-box3">


    </div>
</div>
<script type="text/javascript">
    //    toastr.options.positionClass = 'toast-bottom-right';
    toastr.options.positionClass = 'toast-center-center';
    var totalCount = 10;
    var current = 1;
    $(function () {
        initTableInfo(1);
        initBizType();
        $('.M-box3').pagination({
//            totalData: totalCount,
            pageCount: 50,
            jump: true,
            coping: true,
            homePage: '首页',
            endPage: '末页',
            prevContent: '上页',
            nextContent: '下页',
            showData: 10,
            callback: function (api) {
                current=api.getCurrent();
                initTableInfo(current)
            }
        });
        $(".show-key-detail").on("click", function () {
            var detailBut = $(this);
            alert(detailBut.val());
            $("#showKeyDetail").modal("show");
        });

        $("#search-redis-list").on("click",function(){
            console.log("search");
            initTableInfo(current);
        });

        $(".add_redis_button").on("click", function () {
            var key = $("#add-redis-key").val();
            var name = $('#add-redis-key-name').val();
            var parentKey = $('#add-redis-parent-key').val();
            var type = $('#add-redis-key-type').val();
            var bizType = $('#add-redis-key-bizType').val();
            var description = $('#add-key-description').val();
            if (isStringNull(key)) {
                toastr.warning("key不可为空");
                return;
            }
            if (isStringNull(name)) {
                toastr.warning("名称不可为空");
                return;
            }
            if (isStringNull(key)) {
                toastr.warning("parentKey不可为空");
                return;
            }
            if (isStringNull(key)) {
                toastr.warning("描述不可为空");
                return;
            }

            var data = {
                key: key,
                name: name,
                parentKey: parentKey,
                type: type,
                bizType: bizType,
                description: description
            };
            commAjaxByPost("/v1/redis/add/key", data, function (result) {
                if (result.code == 0) {
                    toastr.success("添加成功");
                    $("#addKeyModal").modal('hide');
                       initTableInfo(current);
//                    window.location.reload();
                } else {
                    toastr.error("添加失败");

                }
            }, null, null);
        });


        $("#addKeyModal").on('hidden.bs.modal', '.modal', function () {
            $(this).removeData("bs.modal");
            $(".modal-body").children().remove();
        });

//         $('#addKeyModal').on('shown.bs.modal', function () {


        /* $('.selectpicker').selectpicker({
         //我是对所有的selectpicker操作一次性赋值，如果你想单独赋值，好ok，那么就这样赋值：
         //appendTo("#editcolor .selectpicker"),就这样，在你select元素上面罩上一个div，
         //用div的id就可以标记你要操作的selectpicker，也就是你想操作的select元素标签了
         style: 'btn-info',
         size: 8
         })
         一次搞定一个值的赋值：
         $('#editcolor .selectpicker').selectpicker('val', 1);//默认选中
         $('#editcolor .selectpicker').selectpicker('refresh');
         */
    });


    function initTableInfo(pageNum) {
        showMyModal();
        console.log("当前页"+pageNum);
        pageNum=(pageNum-1)*10;
        console.log("起始条数"+pageNum);
        var parentKey = $('#search-redis-parent-key').val();
        var name = $('#search-redis-key-name').val();
        var keyStr = $('#search-redis-key').val();
        var type = $('#search-redis-key-type').val();
        var bizType = $('#search-redis-key-bizType').val();
        var data = {
            keyStr: keyStr,
            parentKey: parentKey,
            name: name,
            type: type,
            bizType: bizType,
            pageNum: pageNum,
            pageSize: 10
        };
        $('.redisList_table').empty("");
        commAjaxByGET("/v1/redis/keyList", data, function (result) {
            var keyList = result.data.list;
            totalCount = result.data.total;
            console.log("totalCount=" + totalCount);
            if (keyList === undefined || keyList === null) return;
            for (var i = 0; i < keyList.length; i++) {
                appendRow(keyList[i]);
            }
            hideMyModal();

        }, null, null)
    }

    /*function changeMsg(isProtect, projectId, branchName) {

     $(".J_lock_content").html("你确定要保护当分支：" + branchName + " 吗？");
     $(".J_lock_button").attr("data-projectId", projectId);
     $(".J_lock_button").attr("data-branchName", branchName);

     }*/
    <!--  添加redis  key-->
    function initBizType() {
        commAjaxByGET("/v1/redis/key/biztype", null, function (result) {
            var bizTypes = result.data;
            if (bizTypes === undefined || bizTypes === null) {
                console.log("获取业务类型列表失败");
            } else {
                for (var i = 0; i < bizTypes.length; i++) {
                    var select = $('#add-redis-key-bizType');
                    select.append("<option data-content=\"<span class='label label-success'>" + bizTypes[i].typeValue + "</span>\" value="
                            + bizTypes[i].typeKey
                            + " >"
                            + bizTypes[i].typeValue + "</option>");
                    $("#search-redis-key-bizType").append("<option data-content=\"<span class='label label-success'>" + bizTypes[i].typeValue + "</span>\" value="
                            + bizTypes[i].typeKey
                            + " >"
                            + bizTypes[i].typeValue + "</option>");

                }

                $('.selectpicker').selectpicker('render');
                //必须刷新
                $('.selectpicker').selectpicker('refresh');
            }

        }, null, null);

    }

    function showMyModal() {
        $(".J_myModal").show();
    }

    function hideMyModal() {
        $(".J_myModal").hide();
    }

    function appendRow(target) {

        $(".redisList_table").append("<tr>" +
                "<td>" + target.name + "</td>" +
                "<td>" + target.key + "</td>" +
                "<td>" + "<span class=\"label label-success\">" + target.type + "</span>" + "</td>" +
                "<td>" + target.parentKey /*? "<span class=\"label label-primary\">merged</span>" : "<span class=\"label label-default\">false</span>")*/ + "</td>" +
                "<td>" + target.description + "</td>" +
                "<td>" + target.createTime + "</td>" +
                "<td>  " + target.updateTime + "</td>" +
                "<td><button type=\"button\" class=\"show-key-detail btn btn-sm btn-danger\" >详情</button>"  + "</td>" +
                "</tr>");
        <!--data-toggle=\"modal\"  data-target=\"#showKeyDetail\"-->

    }
    //    (target.protect ? "<button type=\"button\" class=\"btn btn-sm btn-danger\" data-toggle=\"modal\" data-target=\".modal-unlock\" onclick='changeMsg(null,\"" + projectId + "\",\"" + target.name + "\")'>解锁</button>" : "") +
</script>
</body>
</html>